import Unit from"./unit.js";import{SupplyLines}from"../mapsheet.js";import{Countries}from"../countries.js";import{Battlecruiser,Battleship,Carrier,Convoy,Destroyer,DestroyerEscort,HeavyCruiser,Kaibokan,LandUnit,LightCruiser,Submarine,TransportShip}from"../units.js";export default class NavalUnit extends Unit{name;attack;submarineAttack;defense;inPort=!1;#e=3;#n=!1;constructor(e,n,a,t,i,r){super(i,r),this.name=e,this.attack=n,this.submarineAttack=a,this.defense=t}setHex(e){super.setHex(e),this.inPort=!1}delete(){super.delete(),this.#n=!1}die(){this.inPort&&this.owner.availableUnits.add(this),this.delete()}outOfSupply(){if(this.#e>0)return!1;const e=this.hex();return(null===e||this.inPort&&SupplyLines.canTraceSupplyLine(e,this.owner))&&(this.#e=3),this.#e<=0}updateSupply(){const e=this.hex();return null===e||this.inPort&&SupplyLines.canTraceSupplyLine(e,this.owner)?this.#e=3:this.#e--,this.embarkedUnits().values().some((e=>e.updateSupply()))}canAttack(e=null){let n=!1;return this.attack>0&&(n||=null===e||e instanceof NavalUnit&&!(e instanceof Submarine)||e instanceof LandUnit),this.submarineAttack>0&&(n||=null===e||e instanceof Submarine),super.canAttack(e)&&n}canAttackInHex(e){const n=this.hex();return!(null===n||null!==e.embarkedOn()||!super.canAttackInHex(e))&&(e instanceof LandUnit?n===e.hex():e instanceof NavalUnit&&(n.adjacentSeaHexes().includes(e.hex())&&(!e.inPort||!e.hex().isMajorPort())))}modifiedLandAttack(){return this.attack/(this.damaged()?10:5)}canEnterHexWithinStackingLimits(e,n=!1,a=e.units()){return!(!n||!e.isMajorPort())||!(n&&!e.isPort())&&[...a.filter((e=>e!==this&&e instanceof NavalUnit))].length<5}validateMovement(e,n){const a=this.owner.partnership().opponent();return e.every(((n,a)=>0===a||n.adjacentSeaHexes(this.owner.partnership()).includes(e[a-1])))&&this.validateMovementThroughNeutralCountries(e)&&!e.values().flatMap((e=>e.navalUnits())).some((e=>e.owner.partnership()!==this.owner.partnership()))&&e.length<=this.movementAllowance&&this.validateMovementThroughControlZones(e,new Set(e.filter((e=>e.isInNavalControlZone(a,this instanceof Submarine)))),!1,!1)}canEmbarkOnto(e){return!1}sameTypeAndStrength(e){return!1}sameBasicType(e){return e instanceof NavalUnit&&!(e instanceof Carrier)&&!(e instanceof TransportShip)&&e.owner.partnership()===this.owner.partnership()}damaged(){return this.#n}damage(){this.canTakeDamage()?this.#n=!0:this.die()}canTakeDamage(){return!this.damaged()}repair(){this.#n=!1}remainingSupply(){return this.#e}toJson(){let e=super.toJson();return e.name=this.name,e.attack=this.attack||void 0,e.submarineAttack=this.submarineAttack||void 0,e.defense=this.defense,e.movementAllowance=this.movementAllowance,e.inPort=this.inPort,e.remainingSupply=this.#e,e.damaged=this.#n,e}static validateNavalUnitJson(e,n){return!("name"in e)||"string"!=typeof e.name||/["&<>]/.test(e.name)?(console.warn("Invalid naval unit: invalid name."),!1):!("attack"in e)||"number"==typeof e.attack&&e.attack>0?!("submarineAttack"in e)||"number"==typeof e.submarineAttack&&e.submarineAttack>0?!("defense"in e)||"number"!=typeof e.defense||e.defense<=0?(console.warn(`Invalid naval unit ${e.name}: invalid defense.`),!1):!("movementAllowance"in e)||"number"!=typeof e.movementAllowance||e.movementAllowance<=0?(console.warn(`Invalid naval unit ${e.name}: invalid movement allowance.`),!1):"inPort"in e&&"boolean"==typeof e.inPort?"remainingSupply"in e&&"number"==typeof e.remainingSupply?"Convoy"!==n||Convoy.validateConvoyJson(e):(console.warn(`Invalid naval unit ${e.name}: invalid remainingSupply.`),!1):(console.warn(`Invalid naval unit ${e.name}: invalid inPort.`),!1):(console.warn(`Invalid naval unit ${e.name}: invalid submarineAttack.`),!1):(console.warn(`Invalid naval unit ${e.name}: invalid attack.`),!1)}static navalUnitFromJson(e,n){const a=e.name,t=e.attack,i=e.submarineAttack,r=e.defense,s=e.movementAllowance;let o;switch(e.type){case"Battlecruiser":o=new Battlecruiser(a,t,r,s,n);break;case"Battleship":o=new Battleship(a,t,r,s,n);break;case"Carrier":o=new Carrier(a,r,s,n,null);break;case"Convoy":const l=new Convoy(n);l.money=e.money??0,l.destination=Countries.fromName(e.destination),o=l;break;case"DestroyerEscort":o=new DestroyerEscort(a,i,r,s,n);break;case"Destroyer":o=new Destroyer(a,t,r,s,n);break;case"HeavyCruiser":o=new HeavyCruiser(a,t,r,s,n);break;case"Kaibokan":o=new Kaibokan(a,i,r,s,n);break;case"LightCruiser":o=new LightCruiser(a,t,r,s,n);break;case"Submarine":o=new Submarine(a,t,r,s,n);break;case"TransportShip":o=new TransportShip(n);break;default:throw new TypeError("Unknown unit type")}return o.#e=e.remainingSupply,o.#n=e.damaged??!1,o}}
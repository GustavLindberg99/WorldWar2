import lodash from"https://cdn.jsdelivr.net/npm/lodash@4.17.21/+esm";import{SupplyLines}from"../model/mapsheet.js";import{Armor,SupplyUnit}from"../model/units.js";import{date}from"../model/date.js";import ErrorMessages from"./error-messages.js";import HexMarker from"./markers/hex-marker.js";import InfoBubble from"./info/info-bubble.js";import UnitMarker from"./markers/unit-marker.js";export default class PlaceLandUnitsBubble{#t;#e;#n=new Map;#i=null;constructor(t,e,n){this.#e=t,this.#t=n;const i=this.#e.controller();if(null===i)return void Toastify({text:"You can only place land units and build installations in land hexes."}).showToast();if(i.partnership()!==e)return void Toastify({text:"You can only place land units and build installations in hexes that you control."}).showToast();let s='\n            <button id="PlaceLandUnitsBubble.placeLandUnits">Place land unit</button>\n            <div id="PlaceLandUnitsBubble.existingLandUnits"></div>';this.#e.fortified()||this.#e.fortUnderConstruction()?this.#e.fortRecentlyBuilt()&&(s+='<button id="PlaceLandUnitsBubble.buildFortification">Undo build fortification</button>'):s+='<button id="PlaceLandUnitsBubble.buildFortification" title="Cost: $500B, construction finished in 2 months">Build fortification</button>',this.#e.hasAirfield()||this.#e.airfieldUnderConstruction()?this.#e.airfieldRecentlyBuilt()&&(s+='<button id="PlaceLandUnitsBubble.buildAirfield">Undo build airfield</button>'):s+='<button id="PlaceLandUnitsBubble.buildAirfield" title="Cost: $400B, construction finished in 2 months">Build airfield</button>',(this.#e.installationsDestroyed||this.#e.resourceHexDestroyed)&&(s+='<button id="PlaceLandUnitsBubble.repairInstallations" title="Cost: $200B">Repair installations</button>');const a=InfoBubble.hexTippy(this.#e,{content:s,hideOnClick:!1});document.body.addEventListener("mousedown",(t=>{if(0!==t.button)return;const e=t.target;a.popper.contains(e)||this.#i?.popper.contains(e)||a.destroy()}));const o=document.getElementById("PlaceLandUnitsBubble.placeLandUnits");null!==o&&(o.onclick=()=>{const t=this.#e.country;let n=[];for(let t of this.#t.availableLandUnits)this.#e.unitCanBePlacedHere(t)&&!n.some((e=>e.sameType(t)))&&n.push(t);if(0===n.length)t.partnership()===e?Toastify({text:`${t.name()} doesn't have any land units that can be placed.`}).showToast():Toastify({text:"You can only place new land units in their home country."}).showToast();else if(1===n.length)this.#s(n[0]);else{this.#i=tippy(o,{content:'<div id="PlaceLandUnitsBubble.newLandUnits"></div>'});const t=document.getElementById("PlaceLandUnitsBubble.newLandUnits");for(let e of n){const n=UnitMarker.get(e).createCopyImage(!1);n.onclick=()=>this.#s(e),t.appendChild(n)}}});const r=document.getElementById("PlaceLandUnitsBubble.buildFortification");null!==r&&(r.onclick=()=>{this.#e.fortUnderConstruction()?(this.#e.destroyFortification(),i.money+=500,r.textContent="Build fortification"):i.money<500?ErrorMessages.showNotEnoughMoneyError(i,500):(this.#e.startBuildingFortification(),i.money-=500,r.textContent="Undo build fortification"),HexMarker.updateMarkers(this.#e)});const l=document.getElementById("PlaceLandUnitsBubble.buildAirfield");null!==l&&(l.onclick=()=>{this.#e.airfieldUnderConstruction()?(this.#e.destroyAirfield(),i.money+=400,l.textContent="Build airfield"):i.money<400?ErrorMessages.showNotEnoughMoneyError(i,400):(this.#e.startBuildingAirfield(),i.money-=400,l.textContent="Undo build airfield"),HexMarker.updateMarkers(this.#e)});const h=document.getElementById("PlaceLandUnitsBubble.repairInstallations");null!==h&&(h.onclick=()=>{i.money<200?ErrorMessages.showNotEnoughMoneyError(i,200):(this.#e.repairInstallations(),i.money-=200,h.remove()),HexMarker.updateMarkers(this.#e)});for(let t of this.#e.landUnits())this.#a(t)}#o(t,e=!0,n=!0,i=!1){if(!i&&!this.#e.unitCanBePlacedHere(t))return e&&Toastify({text:"You can only place new land units in their home country."}).showToast(),!1;if(t.strength>=t.maxStrength())return e&&Toastify({text:`This type of unit can't be stronger than ${t.maxStrength()} strength points.`}).showToast(),!1;if(n){const n=this.#t.availableLandUnits.find((e=>e.sameType(t)));if(void 0===n)return e&&Toastify({text:`${t.owner.name()} doesn't have any more available strength points of the same type as this unit.`}).showToast(),!1;lodash.pull(this.#t.availableLandUnits,n),this.#t.updateUnitsInLeftPanel()}return t.strength++,UnitMarker.get(t).update(),this.#n.get(t).querySelector(".imageContainer").replaceChildren(UnitMarker.get(t).createCopyImage(!1)),!0}#r(t,e=!0,n=!0){const i=(t,e)=>t+(e instanceof SupplyUnit?1:e.strength),s=this.#t.initialUnitsAtHex.get(this.#e).filter((e=>e.sameType(t))).reduce(i,0),a=this.#e.landUnits().filter((e=>e.sameType(t))).reduce(i,0);if(t.isAlive()){if(a<=s&&n)return e&&Toastify({text:"You can't remove units that were already in this hex before."}).showToast(),!1;if(t.strength<=1)return t.delete(),UnitMarker.get(t).update(),n&&(this.#t.availableLandUnits.push(t),this.#t.updateUnitsInLeftPanel()),this.#n.get(t).remove(),this.#n.delete(t),!0;{const e=t.clone();return e instanceof SupplyUnit||(e.strength=1),n&&(this.#t.availableLandUnits.push(e),this.#t.updateUnitsInLeftPanel()),t.strength--,UnitMarker.get(t).update(),this.#n.get(t).querySelector(".imageContainer").replaceChildren(UnitMarker.get(t).createCopyImage(!1)),!0}}return!1}#a(t){this.#t.initialUnitsAtHex.has(this.#e)||this.#t.initialUnitsAtHex.set(this.#e,[...this.#e.landUnits().map((t=>t.clone()))]);const e=document.createElement("p"),n=document.createElement("span");n.className="imageContainer",n.appendChild(UnitMarker.get(t).createCopyImage(!1)),e.appendChild(n);const i=document.createElement("button");i.textContent="⤒",i.title="Increase strength as much as possible";const s=document.createElement("button");s.textContent="↑",s.title="Increase strength by one strength point";const a=document.createElement("button");a.textContent="↓",a.title="Decrease strength by one strength point";const o=document.createElement("button");o.textContent="⤓",o.title="Decrease strength as much as possible";const r=document.createElement("button");r.textContent="Transfer strength",t.maxStrength()>1&&e.appendChild(i),e.appendChild(s),e.appendChild(a),t.maxStrength()>1&&(e.appendChild(o),e.appendChild(r));document.getElementById("PlaceLandUnitsBubble.existingLandUnits").appendChild(e),this.#n.set(t,e),i.onclick=()=>{let e=!0;for(;this.#o(t,e);)e=!1},s.onclick=()=>{this.#o(t)},a.onclick=()=>{this.#r(t)},o.onclick=()=>{let e=!0;for(;this.#r(t,e);)e=!1},r.onclick=()=>{const e=this.#e.landUnits().find((e=>e!==t&&e.sameType(t)));if(void 0===e){const e=t.clone();e.strength=1,e.canEnterHexWithinStackingLimits(this.#e)?(this.#r(t,!0,!1),this.#s(e,!1)):Toastify({text:"This unit can't be split up because of stacking limits."}).showToast()}else this.#o(e,!0,!1,!0)&&this.#r(t,!1,!1)}}#s(t,e=!0){t.canEnterHexWithinStackingLimits(this.#e)?t instanceof Armor&&(this.#e.isDesert()||this.#e.isIcecap())?Toastify({text:"Armor units can't be placed in desert or icecap hexes."}).showToast():!e||SupplyLines.canTraceSupplyLine(this.#e,t.owner,!(t instanceof SupplyUnit))||t instanceof SupplyUnit&&date.current===t.owner.enteredWar?(this.#a(t),t.setHex(this.#e),UnitMarker.get(t).update(),lodash.pull(this.#t.availableLandUnits,t),this.#t.updateUnitsInLeftPanel()):date.current===t.owner.enteredWar?Toastify({text:"New non-supply units can't be placed in hexes that are out of supply. To place a unit here, you must first place a supply unit in a hex that can trace a supply line to this hex."}).showToast():Toastify({text:"New units can't be placed in hexes that are out of supply."}).showToast():Toastify({text:"This unit can't be placed here because of stacking limits. If possible, try increasing the strength of an existing unit in this hex, otherwise place this unit somewhere else."}).showToast()}}
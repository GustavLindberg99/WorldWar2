import HexMarker from"./hex-marker.js";import PanZoom from"../pan-zoom.js";import UnitMarker from"./unit-marker.js";export default class MoveUnitListener{#e;#t;#s;#i=NaN;#o=NaN;#n=0;ondragstart=null;ondragmove=null;ondragfinished=null;onunitbubblecreate=null;onunitbubblemouseover=null;onunitbubblemouseout=null;static#r=null;constructor(e,t,s){this.#e=t,this.#e.style.cursor="grab",this.#e.addEventListener("mousedown",this.#a),this.#e.addEventListener("touchstart",this.#a),this.#t=UnitMarker.get(e).createCopyImage(!1),this.#t.style.position="absolute",this.#s=s}delete(){this.#e.removeEventListener("mousedown",this.#a),this.#e.removeEventListener("touchstart",this.#a),this.#e.style.cursor="",this.#u()}simulateDragStart(e,t){this.#a(e,!1),this.#n=t}#u(){window.removeEventListener("mousemove",this.#m,{capture:!0}),window.removeEventListener("touchmove",this.#m,{capture:!0}),window.removeEventListener("mouseup",this.#h),window.removeEventListener("touchend",this.#h),this.#n=0,this.#e.style.visibility="",this.#t.remove(),document.body.style.cursor="",MoveUnitListener.#r=null}#l(e){let t,s;if(e.cancelable&&e.preventDefault(),e instanceof MouseEvent)t=e.pageX,s=e.pageY,this.#i=e.clientX,this.#o=e.clientY;else{if(!(e instanceof TouchEvent))throw new TypeError("Unknown event type");t=e.touches[0].pageX,s=e.touches[0].pageY,this.#i=e.touches[0].clientX,this.#o=e.touches[0].clientY}this.#t.style.left=t+3+this.#n+"px",this.#t.style.top=s+3+this.#n+"px"}#c(e){return this.#s||document.getElementById("mapsheet").contains(e.target)?HexMarker.hexAtPoint(this.#i,this.#o):null}#a=(e,t=!0)=>{e instanceof MouseEvent&&0!==e.button||(document.body.appendChild(this.#t),t&&(e.stopPropagation(),null!==e&&!1===this.ondragstart?.(e))?this.#t.remove():(window.addEventListener("mousemove",this.#m,{capture:!0}),window.addEventListener("touchmove",this.#m,{capture:!0,passive:!1}),window.addEventListener("mouseup",this.#h),window.addEventListener("touchend",this.#h),this.#e.style.visibility="hidden",document.body.style.cursor="grabbing",MoveUnitListener.#r=this,this.#l(e)))};#m=e=>{if(this.#l(e),this.#s){const e=document.getElementById("mapsheet").getBoundingClientRect();this.#i<e.left&&PanZoom.instance().panBy({x:10,y:0}),this.#i>e.right&&PanZoom.instance().panBy({x:-10,y:0}),this.#o<e.top&&PanZoom.instance().panBy({x:0,y:10}),this.#o>e.bottom&&PanZoom.instance().panBy({x:0,y:-10})}this.ondragmove?.(this.#c(e))};#h=e=>{this.#u(),this.ondragfinished?.(this.#c(e))};static activeListener(){return MoveUnitListener.#r}}
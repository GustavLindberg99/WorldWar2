import lodash from"https://cdn.jsdelivr.net/npm/lodash@4.17.21/+esm";import Color from"https://colorjs.io/dist/color.min.js";import{joinIterables,wait}from"../../utils.js";import{Hex}from"../../model/mapsheet.js";import{Partnership}from"../../model/partnership.js";import{AirUnit,Armor,Carrier,Convoy,Infantry,LandUnit,Marine,NavalUnit,Paratrooper,Submarine,SupplyUnit,TransportShip}from"../../model/units.js";import HexMarker from"./hex-marker.js";import InfoBubble from"../info/info-bubble.js";import MoveUnitListener from"./move-unit-listener.js";import HumanPlayer from"../../controller/player/human-player.js";import Player from"../../controller/player/player.js";export default class UnitMarker{#t;#e;#i=new Map;#r;#n;#s=null;#a=[];#o=null;#l=null;onclick=null;static#h=new Set;static#u=null;static#c=new Set;static#m=null;static#d=new Map;#f=[["images/inside.svg","Embarked units:",()=>this.#r.embarkedUnits().size>0],["images/landing-plane.svg","Based",()=>this.#r instanceof AirUnit&&this.#r.based],["images/port.svg","In port",()=>this.#r instanceof NavalUnit&&this.#r.inPort()],["images/damaged.svg","Damaged",()=>(this.#r instanceof AirUnit||this.#r instanceof NavalUnit)&&this.#r.damaged()],["images/sword.svg","Has attacked this turn",()=>this.#r.hasAttacked],["images/train.svg","Moving by rail",()=>this.#r instanceof LandUnit&&this.#r.movingByRail]];constructor(t){if(this.#r=t,t instanceof LandUnit)this.#e=document.querySelector("#landUnits");else if(t instanceof AirUnit)this.#e=document.querySelector("#airUnits");else{if(!(t instanceof NavalUnit))throw new TypeError("Unknown unit type");this.#e=document.querySelector("#navalUnits")}this.#t=this.#p("g"),this.#t.onmouseover=t=>this.#k(t),this.#t.onmouseout=t=>this.#b(t),this.#e.appendChild(this.#t),UnitMarker.#d.set(this.#r,this),this.#t.onclick=t=>{if(null!==this.onclick)this.onclick();else{HexMarker.hexAtPoint(t.clientX,t.clientY)===this.#n&&HexMarker.onhexclick?.(this.#n,t)}},this.#t.oncontextmenu=t=>{const e=HexMarker.hexAtPoint(t.clientX,t.clientY);null!==e&&(InfoBubble.showHexInfo(e),t.preventDefault())},this.#n=this.#r.hex(),this.update()}createCopyImage(t,e=!1,i="2em"){const r=this.#p("svg",t);if(r.setAttribute("width",i),r.setAttribute("height",i),r.setAttribute("viewBox","0 0 3 3"),r.classList.add("copyImage"),r.style.marginRight="4px",r.style.userSelect="none",r.style.verticalAlign="middle",e)for(let t of this.#i.keys())r.appendChild(t.cloneNode());return r}#p(t,e=!0){const i=document.createElementNS("http://www.w3.org/2000/svg",t);i.classList.add("unit");const r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.classList.add("markerBackground"),r.setAttribute("fill",this.#r.owner.color()),i.appendChild(r);const n=new Color(this.#r.owner.color()),s=n.luminance<.3?"white":"black",a=this.#w();if(null!==a){const t=document.createElementNS("http://www.w3.org/2000/svg","text");t.setAttribute("class","topLeftText"),t.textContent=a,t.setAttribute("fill",s),t.setAttribute("x","0.3"),t.setAttribute("y","1.1"),t.setAttribute("text-anchor","start"),i.appendChild(t)}const o=this.#g();if(null!==o){const t=document.createElementNS("http://www.w3.org/2000/svg","text");t.setAttribute("class","topRightText"),t.textContent=o,t.setAttribute("fill",s),t.setAttribute("x","2.7"),t.setAttribute("y","1.1"),t.setAttribute("text-anchor","end"),i.appendChild(t)}const l=document.createElementNS("http://www.w3.org/2000/svg","text");l.setAttribute("class","bottomLeftText"),l.textContent=this.#x(),l.setAttribute("fill",s),l.setAttribute("x","0.3"),l.setAttribute("y","2.6"),l.setAttribute("text-anchor","start"),i.appendChild(l);const h=document.createElementNS("http://www.w3.org/2000/svg","text");h.setAttribute("class","bottomRightText"),h.textContent=this.#M(),h.setAttribute("fill",s),h.setAttribute("x","2.7"),h.setAttribute("y","2.6"),h.setAttribute("text-anchor","end"),i.appendChild(h);const u=this.#A();return u.classList.add("unitMarkerImage"),n.luminance<.3&&(u.style.filter="url(#invert)"),i.appendChild(u),e&&(i.onmouseover=t=>{i.contains(t.relatedTarget)||InfoBubble.showUnitInfo(this.#r,i)}),i}delete(){UnitMarker.#d.delete(this.#r),this.#t.remove()}update(){const t=this.#r.hex();if(null===t)this.delete();else{this.#v(t);const e=this.#t.querySelector(".topLeftText");null!==e&&(e.textContent=this.#w());const i=this.#t.querySelector(".topRightText");null!==i&&(i.textContent=this.#g()),this.#t.querySelector(".bottomLeftText").textContent=this.#x(),this.#t.querySelector(".bottomRightText").textContent=this.#M();for(let[t,e,i]of this.#f)i()?this.#U(t,e):this.#y(t)}null!==this.#r.embarkedOn()&&this.delete()}createMoveUnitListener(t){return this.#l?.delete(),this.#l=new MoveUnitListener(this.#r,this.#t,t),this.#l}select(){this.#t.classList.add("selected")}deselect(){this.#t.classList.remove("selected")}infoMarkers(){return this.#i}#S(){const t=this.#r.owner.partnership();return t!==Partnership.Neutral&&Player.fromPartnership(t)instanceof HumanPlayer}#I(){return this.#r.owner.partnership()===Partnership.Neutral}#v(t){const e=this.#n.units(),i=t.units();this.#n=t;for(let[t,r]of[...[...e].entries(),...[...i].entries()]){const e=UnitMarker.#d.get(r);void 0!==e&&(0===t&&[...r.hex().units()].length>1?e.#t.style.filter="url(#shadow)":e.#t.style.filter="")}this.#C()}#w(){return this.#r instanceof AirUnit?this.#r.isTransportUnit()?"T":this.#r.fighterStrength.toString():this.#r instanceof Carrier?"C":this.#r instanceof TransportShip?"T":this.#r instanceof Convoy?"$":this.#r instanceof NavalUnit?this.#r.attack.toString():null}#g(){return this.#r instanceof AirUnit||this.#r instanceof NavalUnit?this.#r.defense.toString():null}#x(){if(this.#r instanceof LandUnit)return this.#r.strength.toString();if(this.#r instanceof AirUnit){let t=(this.#r.bomberStrength||this.#r.kamikazeBaseStrength).toString();return 0===this.#r.bomberStrength&&this.#r.kamikazeBaseStrength>0&&(t+="ᴷ"),t}if(this.#r instanceof NavalUnit)return this.#r.submarineAttack.toString();throw new TypeError("Unknown unit type")}#M(){let t=this.#r.movementAllowance.toString();return this.#r instanceof AirUnit&&this.#r.carrierBased()&&(t+="ꟲ"),t}#A(){if(this.#r instanceof LandUnit){const t=document.createElementNS("http://www.w3.org/2000/svg","g"),e=document.createElementNS("http://www.w3.org/2000/svg","path");if(e.setAttribute("d",this.#S()?"M-1,-0.5 L1,-0.5 L1,0.5 L-1,0.5 Z":this.#I()?"M-0.5,-0.5 L0.5,-0.5 L0.5,0.5 L-0.5,0.5 Z":"M-0.7,0 L0,-0.7 L0.7,0 L0,0.7 Z"),t.appendChild(e),this.#r instanceof Armor){const e=document.createElementNS("http://www.w3.org/2000/svg","ellipse");e.setAttribute("cx","0"),e.setAttribute("cy","0"),e.setAttribute("rx",this.#S()?"0.7":"0.5"),e.setAttribute("ry","0.3"),t.appendChild(e)}else if(this.#r instanceof Infantry){const e=document.createElementNS("http://www.w3.org/2000/svg","path");e.setAttribute("d",this.#S()?"M-1,-0.5 L1,0.5 M1,-0.5 L-1,0.5":this.#I()?"M-0.5,-0.5 L0.5,0.5 M0.5,-0.5 L-0.5,0.5":"M-0.35,-0.35 L0.35,0.35 M-0.35,0.35 L0.35,-0.35"),t.appendChild(e)}else if(this.#r instanceof Marine){const e=document.createElementNS("http://www.w3.org/2000/svg","path");e.setAttribute("d","M0,-0.2 V0.35 M-0.2,-0.05 h0.4 M-0.3,0.15 a0.6,1.5,0,0,0,0.6,0 M0,-0.2 a0.09,0.09,0,0,0,0,-0.18 a0.09,0.09,0,0,0,0,0.18"),t.appendChild(e)}else if(this.#r instanceof Paratrooper){const e=document.createElementNS("http://www.w3.org/2000/svg","path");e.setAttribute("d","M-0.3,-0.1 l0.3,0.4 l0.3,-0.4 a0.3,0.2,180,0,0,-0.6,0 h0.6"),t.appendChild(e)}else if(this.#r instanceof SupplyUnit){const e=document.createElementNS("http://www.w3.org/2000/svg","path");e.setAttribute("d",this.#S()?"M-1,0.3h2":this.#I()?"M-0.5,0.3h1":"M-0.4,0.3h0.8"),t.appendChild(e)}return t}if(this.#r instanceof AirUnit){const t=document.createElementNS("http://www.w3.org/2000/svg","image");return t.setAttribute("href",this.#r.imageUrl),t.setAttribute("x","-0.55"),t.setAttribute("y","-0.25"),t.setAttribute("width","1.1"),t.setAttribute("height","1.5"),t.setAttribute("preserveAspectRatio","none"),t}if(this.#r instanceof NavalUnit){const t=document.createElementNS("http://www.w3.org/2000/svg","image");return this.#r instanceof Submarine?t.setAttribute("href","images/ships/submarine.svg"):this.#r instanceof Carrier?t.setAttribute("href","images/ships/carrier.svg"):t.setAttribute("href","images/ships/ship.svg"),t.setAttribute("x","-1"),t.setAttribute("y","-0.5"),t.setAttribute("width","2"),t.setAttribute("height","1.5"),t.setAttribute("preserveAspectRatio","none"),t}throw new TypeError("Unknown unit type")}#k(t){const e=t.relatedTarget;if(this.#t.contains(e))return;UnitMarker.#h.add(this.#n);const i=UnitMarker.#u!==this.#n;UnitMarker.#u=this.#n;const r=[...UnitMarker.#L(this.#n)],n=r.filter((t=>t.#r instanceof NavalUnit&&!(t.#r instanceof Carrier)&&!(t.#r instanceof TransportShip))),s=n.at(-1);let a=[];if(!UnitMarker.#c.has(this.#n)&&void 0!==s&&n.length>5&&n.length<[...this.#n.units()].length&&(s.#N(n),a=lodash.without(n,s),lodash.pull(r,...a)),i&&r.length>1&&(t instanceof PointerEvent||!r.some((t=>t.#t.contains(e))))){for(let[t,e]of r.entries()){e.#T(!1),null!==e.#o&&clearInterval(e.#o);const i=performance.now();e.#o=setInterval((()=>{const r=Math.min(.002*(performance.now()-i),1.5);if(e.#C(t*r),e===s)for(let t of a)t.#t.style.transform=e.#t.style.transform;r>=1.5&&null!==e.#o&&(clearInterval(e.#o),e.#o=null)}),0)}for(let t of UnitMarker.#L(this.#n))t.#t.style.filter=""}else if(r.every((t=>null===t.#o))){this.#T(!1),null!==UnitMarker.#m&&clearInterval(UnitMarker.#m),InfoBubble.closeOtherUnitInfoBubbles(this.#r),1===[...this.#n.units()].length?InfoBubble.showUnitInfo(this.#r,this.#t):UnitMarker.#m=setTimeout((()=>{null===document.getElementById("PlaceLandUnitsBubble.placeLandUnits")&&InfoBubble.showUnitInfo(this.#r,this.#t)}),1e3);for(let t of this.#i.keys())t.setAttribute("y","2.7"),t.setAttribute("opacity","1")}}async#b(t){const e=t.relatedTarget,i=[...UnitMarker.#L(this.#n)];if(!(i.some((t=>t.#t.contains(e)||t.#s?.contains(e)))||e?.matches(".bubble *")||e?.matches(".tip *")||e?.matches(".copyImage *")||(UnitMarker.#h.delete(this.#n),await wait(500),UnitMarker.#h.has(this.#n)))){i.length>1&&(i[0].#t.style.filter="url(#shadow)"),UnitMarker.#c.delete(this.#n);for(let t of i)t.#r.isAlive()&&(null!==t.#o&&(clearInterval(t.#o),t.#o=null),t.#E(),t.#C(),t.#T(!0));UnitMarker.#u=null,null!==UnitMarker.#m&&(clearTimeout(UnitMarker.#m),UnitMarker.#m=null);for(let t of this.#i.keys())t.setAttribute("y","2"),t.setAttribute("opacity","0.5")}}#U(t,e){if(this.#i.keys().some((e=>e.getAttribute("href")===t)))return;const i=document.createElementNS("http://www.w3.org/2000/svg","image");i.classList.add("infoMarker"),i.setAttribute("href",t),i.setAttribute("preserveAspectRatio","none"),i.setAttribute("width","1"),i.setAttribute("height","1"),i.setAttribute("x",(2-this.#i.size).toString()),this.#i.size>0?(i.setAttribute("y",[...this.#i.keys()][0].getAttribute("y")),i.setAttribute("opacity",[...this.#i.keys()][0].getAttribute("opacity"))):(i.setAttribute("y","2"),i.setAttribute("opacity","0.5")),this.#t.appendChild(i),this.#i.set(i,e)}#y(t){let e=0;for(let i of[...this.#i.keys()])i.getAttribute("href")===t?(this.#t.removeChild(i),this.#i.delete(i)):(i.setAttribute("x",(2-e).toString()),e++)}#N(t){this.#a=t;const e="x"+t.length,i=Math.min(...t.map((t=>t.#r.movementAllowance)));if(null===this.#s){for(let e of t)e.#t.style.visibility="hidden";this.#s=document.createElementNS("http://www.w3.org/2000/svg","g"),this.#s.classList.add("unit"),this.#s.onclick=t=>{this.#E(),UnitMarker.#c.add(this.#n),UnitMarker.#u=null,this.#k(t)},this.#s.oncontextmenu=this.#t.oncontextmenu,tippy(this.#s,{content:`${t.length} units, click to show`,showOnCreate:!1,trigger:"mouseenter focus"});const r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.classList.add("markerBackground"),r.setAttribute("fill",this.#r.owner.color()),this.#s.appendChild(r);const n=new Color(this.#r.owner.color()),s=n.luminance<.3?"white":"black",a=document.createElementNS("http://www.w3.org/2000/svg","text");a.textContent=e,a.setAttribute("font-size","0.8px"),a.setAttribute("fill",s),a.setAttribute("x","2.7"),a.setAttribute("y","1.1"),a.setAttribute("text-anchor","end"),a.setAttribute("font-weight","bold"),this.#s.appendChild(a);const o=document.createElementNS("http://www.w3.org/2000/svg","text");o.textContent=i.toString(),o.setAttribute("font-size","0.8px"),o.setAttribute("fill",s),o.setAttribute("x","2.7"),o.setAttribute("y","2.7"),o.setAttribute("text-anchor","end"),o.setAttribute("font-weight","bold"),this.#s.appendChild(o);const l=document.createElementNS("http://www.w3.org/2000/svg","image");l.setAttribute("href","images/ships/fleet.svg"),l.setAttribute("x","0.5"),l.setAttribute("y","0.75"),l.setAttribute("width","2"),l.setAttribute("height","1.5"),l.setAttribute("preserveAspectRatio","none"),n.luminance<.3&&(l.style.filter="url(#invert)"),this.#s.appendChild(l),this.#e.appendChild(this.#s)}else this.#s.querySelector("text").textContent=e,this.#s.querySelector("text+text").textContent=i.toString()}#E(){null!==this.#s&&(this.#s.remove(),this.#s=null);for(let t of this.#a)t.#t.style.visibility="";this.#a=[]}#T(t){if(null===this.#t.parentElement)return;const e=t?this.#e:document.querySelector("#selectedUnits");this.#t.remove(),e.appendChild(this.#t),null!==this.#s&&(this.#s.remove(),e.appendChild(this.#s))}#C(t=0){this.#t.style.transform=`translate(${this.#n.centerX()-Hex.hexWidth/3}px,${this.#n.centerY()-Hex.hexWidth/3}px) translate(${t}px,${t}px) scale(${3/Hex.hexWidth})`,null!==this.#s&&(this.#s.style.transform=this.#t.style.transform)}static#L(t){return joinIterables(t.navalUnits(),t.landUnits(),t.airUnits()).map((t=>UnitMarker.#d.get(t))).filter((t=>void 0!==t))}static get(t){return UnitMarker.#d.get(t)??new UnitMarker(t)}static expandedStack(){return this.#u?.units()??null}}
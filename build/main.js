import{refreshUI}from"./utils.js";import{Hex}from"./model/mapsheet.js";import{Partnership}from"./model/partnership.js";import{Countries}from"./model/countries.js";import{Unit}from"./model/units.js";import{date,Month}from"./model/date.js";import{SavedGames}from"./model/saved-games.js";import CountryList from"./view/info/country-list.js";import HexMarker from"./view/markers/hex-marker.js";import InitView from"./view/init/init-view.js";import PanZoom from"./view/pan-zoom.js";import UnitMarker from"./view/markers/unit-marker.js";import ComputerPlayer from"./controller/player/computer-player.js";import HumanPlayer from"./controller/player/human-player.js";import runGame from"./controller/run-game.js";function placePrebuiltInstallations(){for(let e of Hex.allHexes)("Gibraltar"===e.city||"Malta"===e.city||"Sevastopol"===e.city||e.country===Countries.france&&e.adjacentLandHexes().some((e=>e.country===Countries.germany)))&&(e.startBuildingFortification(),e.continueBuilding(),e.continueBuilding(),HexMarker.updateMarkers(e));const e=Hex.fromCoordinates(269,146);e.startBuildingAirfield(),e.continueBuilding(),e.continueBuilding(),HexMarker.updateMarkers(e)}function fastForwardTo1939(){for(;date.current<date(1939,Month.September);date.current++)for(let e of Countries.all())e.addNewAvailableUnits();for(let e of Countries.china.hexes)e.secondaryController===Countries.japan&&e.setController(Countries.japan)}async function startGame(e,t){document.getElementById("loadingView").style.visibility="visible",await refreshUI(),t&&fastForwardTo1939(),Countries.china.joinPartnership(Partnership.Allies),Countries.japan.joinPartnership(Partnership.Axis),Countries.japan.enteredWar=Countries.china.enteredWar=date.current,await InitView.drawHexGrid(),InitView.enableButtons(),placePrebuiltInstallations(),document.getElementById("loadingView").style.visibility="hidden",PanZoom.initialize(),t?(PanZoom.instance().zoom(5),HexMarker.scrollToHex(Hex.fromCoordinates(200,160))):(PanZoom.instance().zoom(10),HexMarker.scrollToHex(Hex.allCityHexes.find((e=>"Beijing"===e.city))));const n=new HumanPlayer(e),a=new ComputerPlayer(e.opponent());runGame(n,a);try{localStorage?.removeItem("autosave")}catch{}}async function openSavedGame(e){document.getElementById("loadingView").style.visibility="visible",await refreshUI(),SavedGames.loadGameFromJson(e),await InitView.drawHexGrid();const t=new HumanPlayer(Partnership[e.humanPartnership]),n=new ComputerPlayer(t.partnership.opponent());for(let t of e.hexes)HexMarker.updateMarkers(Hex.fromCoordinates(t.x,t.y)),await refreshUI();for(let e of Unit.allAliveUnits())UnitMarker.get(e).update(),await refreshUI();if(InitView.enableButtons(),document.getElementById("loadingView").style.visibility="hidden",PanZoom.initialize(),"zoom"in e&&"number"==typeof e.zoom&&PanZoom.setAbsoluteZoom(e.zoom),"panX"in e&&"panY"in e&&"number"==typeof e.panX&&"number"==typeof e.panY){const[t,n]=PanZoom.svgPixelToClientPixel(e.panX,e.panY);PanZoom.instance().pan({x:t,y:n})}runGame(t,n)}async function main(){tippy.setDefaultProps({allowHTML:!0,placement:"right",showOnCreate:!0,trigger:"manual",hideOnClick:!0}),Toastify.defaults.style={background:"red"},Toastify.defaults.close=!0,Toastify.defaults.duration=1e4,document.getElementById("startGameAllies1937").onclick=()=>startGame(Partnership.Allies,!1),document.getElementById("startGameAxis1937").onclick=()=>startGame(Partnership.Axis,!1),document.getElementById("startGameAllies1939").onclick=()=>startGame(Partnership.Allies,!0),document.getElementById("startGameAxis1939").onclick=()=>startGame(Partnership.Axis,!0);const e=document.getElementById("continueLastPlayedGameButton");let t;try{t=JSON.parse(localStorage?.getItem("autosave"))}catch{t=null}null!==t&&(SavedGames.validateJson(t)?(e.onclick=async()=>{await openSavedGame(t)},e.style.display=""):console.error("Invalid autosaved game."));const n=document.querySelector("input#openSavedGameButton");let a;n.onchange=async()=>{const e=n.files?.[0];if(void 0===e)return;document.getElementById("loadingView").style.visibility="visible";const t=new FileReader;await new Promise((n=>{t.onload=n,t.readAsText(e,"UTF-8")}));const a=t.result;let r;try{r=JSON.parse(a)}catch{r=null}if(!SavedGames.validateJson(r))return document.getElementById("loadingView").style.visibility="hidden",void Toastify({text:"This file is not a valid saved game."}).showToast();await openSavedGame(r),document.getElementById("loadingView").style.visibility="hidden"};try{a=(await(await fetch("package.json")).json()).version}catch{}document.getElementById("aboutButton").onclick=()=>{xdialog.open({title:"About WorldWar2",body:`\n                <p>Version ${a}</p>\n                <p>Copyright &copy; Gustav Lindberg</p>\n                <p>\n                    <a href="LICENSE" rel="license">Terms of Use</a> •\n                    <a href="PRIVACY.md">Privacy Policy</a> •\n                    <a href="https://github.com/GustavLindberg99/WorldWar2/issues/new">Contact Us</a>\n                </p>\n                <p>Icons made by <a href="https://www.iconfinder.com/paomedia" rel="external">Paomedia</a>, <a href="https://www.iconfinder.com/webalys" rel="external">Webalys</a>, <a href="https://www.iconfinder.com/Chanut-is" rel="external">Chanut is Industries</a>, <a href="https://www.iconfinder.com/iconfinder" rel="external">Iconfinder</a>, <a href="https://www.iconfinder.com/kmgdesignid" rel="external">Kmg Design</a>, <a href="https://www.iconfinder.com/iconsets/ionicons" rel="external">Ionicons</a>, <a href="https://www.iconfinder.com/Mr-hopnguyen" rel="external">Hopnguyen Mr</a>, <a href="https://www.iconfinder.com/webhostingmedia" rel="external">David Cross</a>, <a href="https://www.iconfinder.com/pocike" rel="external">Alpár-Etele Méder</a>, <a href="https://www.iconfinder.com/iconsets/circle-icons-1" rel="external">Nick Roach</a>, <a href="https://www.iconfinder.com/fluent-designsystem" rel="external">Microsoft</a>, <a href="https://www.iconfinder.com/webkul" rel="external">Webkul Software</a>, <a href="https://www.iconfinder.com/iconsets/ios-7-icons" rel="external">Visual Pharm</a>, <a href="https://www.iconfinder.com/goodware" rel="external">goodware std.</a>, <a href="https://www.iconfinder.com/font-awesome" rel="external">Font Awesome</a>, <a href="https://www.iconfinder.com/graphiqa" rel="external">Graphiqa Studio</a>, <a href="https://www.iconfinder.com/kucingklawu" rel="external">Kucingklawu Std.</a>, <a href="https://www.iconfinder.com/bendavis" rel="external">Creaticca Ltd</a>, <a href="https://www.iconfinder.com/iconsets/google-material-design-3-0" rel="external">Google</a> and <a href="https://www.iconfinder.com/olivetty" rel="external">Smashicons</a> from <a href="https://www.iconfinder.com/" rel="external">www.iconfinder.com</a> are licensed under <a href="http://creativecommons.org/licenses/by/3.0/" rel="external">CC 3.0 BY</a>. Some of the icons have been modified.</p>\n                <p><a href="https://apvarun.github.io/toastify-js/" rel="external">ToastifyJS</a>, <a href="https://lodash.com/" rel="external">Lodash</a>, <a href="https://colorjs.io/" rel="external">Color.js</a>, <a href="https://kimmobrunfeldt.github.io/progressbar.js/" rel="external">ProgressBar.js</a> and <a href="https://atomiks.github.io/tippyjs/" rel="external">Tippy.js</a> are licensed under the <a href="https://tldrlegal.com/license/mit-license" rel="external">MIT License</a>. <a href="https://xxjapp.github.io/xdialog/" rel="external">Xdialog</a> is licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0" rel="external">Apache License 2.0</a>. <a href="https://github.com/bumbu/svg-pan-zoom" rel="external">Svg-pan-zoom</a> is licensed under the <a href="https://github.com/bumbu/svg-pan-zoom/blob/master/LICENSE" rel="external">BSD-2-Clause license</a>.</p>\n                <p>World map from <a href="https://simplemaps.com/resources/svg-world" rel="external">simplemaps.com</a>.</p>`,buttons:null,style:"width: 400px"})},document.getElementById("countryButton").onclick=()=>{(new CountryList).show()},document.getElementById("loadingView").style.visibility="hidden"}function errorHandler(){xdialog.error('<p>An unexpected error occurred. We apologize for the inconvenience. This means that if you continue playing, things might not work as expected. If you experience any issues, try refreshing the page.</p>\n        <p>If this error persists, please <a href="https://github.com/GustavLindberg99/WorldWar2/issues">contact us</a>. Please include as much information as possible, including what you were doing before you got this error and any information available in the browser\'s developer tools (accessible by pressing the F12 key and going to Console).</p>',{style:"width:400px"})}window.onerror=window.onunhandledrejection=errorHandler,window.addEventListener("load",main);
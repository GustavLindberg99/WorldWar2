import lodash from"https://cdn.jsdelivr.net/npm/lodash@4.17.21/+esm";import{joinIterables,refreshUI,sortNumber}from"../../../utils.js";import{Hex,SupplyLines}from"../../../model/mapsheet.js";import{AirUnit,LandUnit}from"../../../model/units.js";import UnitMarker from"../../../view/markers/unit-marker.js";import FrontLine from"../front-line.js";var AirNavalAutoplacement;!function(e){e.getAirUnitAutoplacement=async function(e,t,n=null){let r=new Map;const i=e=>joinIterables(e.airUnits(),(e=>r.entries().filter((t=>t[1]===e)).map((e=>e[0])))(e)),o=function(e,t){const n=[...e.currentDelayedUnits()],r=[...e.units()],i=new Map,o=(e,...t)=>{const n=i.get(e)??[];n.push(...t),i.set(e,n)};for(let e of r)e.isAlive()&&o(e.hex(),e,e);const a=Hex.allHexes.filter((t=>t.airbaseCapacity()>=1&&t.controller().partnership()===e&&t.country.partnership()===e)),l=Hex.allHexes.filter((t=>t.isPort()&&t.controller().partnership()===e&&t.country.partnership()===e));for(let e of n){let n;if(e instanceof LandUnit)n=lodash.sample(t.filter((t=>[t,...t.adjacentHexes()].some((t=>t.country===e.owner)))));else{const r=(e instanceof AirUnit?a:l).filter((t=>t.controller()===e.owner&&t.country===e.owner));n=lodash.shuffle(r).sort(((e,n)=>e.distanceFromHexGroup(t)-n.distanceFromHexGroup(t)))[Math.floor(Math.random()**4*r.length)]}void 0!==n&&o(n,e)}return i}(e.opponent(),await FrontLine.get(e));let a=new Map;const l=(t,n,r)=>{const i=a.get([t.x,t.y,n,r].toString());if(void 0!==i)return i;let l;l=n&&r?e=>(o.get(e)??[]).length:n?e=>(o.get(e)??[]).filter((e=>e instanceof AirUnit)).length:r?e=>(o.get(e)??[]).filter((e=>!(e instanceof AirUnit))).length:t=>[...t.landUnits().filter((n=>n.owner.partnership()===e&&!n.outOfSupply()&&SupplyLines.canTraceSupplyLine(t,n.owner,!1)))].length;let s=0;for(let e of Hex.allHexes)e.distanceFromHex(t)>15||(e.distanceFromHex(t)>10?s+=l(e):e.distanceFromHex(t)>5?s+=2*l(e):s+=3*l(e));return a.set([t.x,t.y,n,r].toString(),s),s},s=lodash.shuffle(Hex.allHexes.filter((t=>t.airbaseCapacity()-[...t.basedAirUnits()].length>=1&&t.controller().partnership()===e)));let p=0;for(let e of t.toSorted(((e,t)=>e.movementAllowance-t.movementAllowance))){await refreshUI(),p++,n?.(p/t.length);const o=s.filter((t=>e.canEnterHexWithinStackingLimits(t,!0,i(t))&&t.unitCanBePlacedHere(e)&&SupplyLines.canTraceSupplyLine(t,e.owner))),a=lodash.shuffle(o).sort(((t,n)=>sortNumber(n,t,(t=>l(t,e.isFighter(),e.isBomber())))))[0];void 0!==a&&r.set(e,a)}return r},e.getNavalUnitAutoplacement=async function(e,t,n=null){let r=new Map;const i=await FrontLine.get(e),o=e=>joinIterables(e.navalUnits(),(e=>r.entries().filter((t=>t[1]===e)).map((e=>e[0])))(e)),a=Hex.allHexes.filter((t=>t.isPort()&&t.controller().partnership()===e&&!t.navalUnits().some((t=>t.owner.partnership()!==e))&&"Vladivostok"!==t.city)).sort(((t,n)=>sortNumber(n,t,(e=>"Halifax"===e.city))||sortNumber(n,t,(t=>[...t.navalUnits().filter((t=>t.owner.partnership()===e))].length))||sortNumber(n,t,(e=>e.isMajorPort()))||sortNumber(n,t,(e=>!e.isColony))||sortNumber(t,n,(e=>e.distanceFromHexGroup(i)))));let l=0;for(let e of t){await refreshUI(),l++,n?.(l/t.length);const i=a.find((t=>e.canEnterHexWithinStackingLimits(t,!0,o(t))&&t.unitCanBePlacedHere(e)&&SupplyLines.canTraceSupplyLine(t,e.owner)));void 0!==i&&r.set(e,i)}return r},e.placeAirNavalUnits=function(e){for(let[t,n]of e)t.setHex(n),t instanceof AirUnit?t.based=!0:t.inPort=!0,UnitMarker.get(t).update()}}(AirNavalAutoplacement||(AirNavalAutoplacement={}));export default AirNavalAutoplacement;
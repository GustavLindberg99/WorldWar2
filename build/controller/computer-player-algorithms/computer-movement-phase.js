import{refreshUI}from"../../utils.js";import{SupplyLines}from"../../model/mapsheet.js";import{Partnership}from"../../model/partnership.js";import{Countries}from"../../model/countries.js";import{AirUnit,Armor,Convoy,LandUnit,Submarine,SupplyUnit,TransportShip}from"../../model/units.js";import{Phase}from"../../model/phase.js";import HexMarker from"../../view/markers/hex-marker.js";import LeftPanel from"../../view/left-panel.js";import UnitMarker from"../../view/markers/unit-marker.js";export default class ComputerMovementPhase{passedHexes=new Map;#e=new Set;#n;constructor(e){this.#n=e}async run(e){LeftPanel.clear();const n="Your opponent is moving their units...";LeftPanel.appendParagraph(n),LeftPanel.addNextButtonLock(n),await this.#t();let t=null;for(let e of this.#n.units())UnitMarker.get(e).onclick=()=>{Toastify({text:"This unit hasn't moved this turn."}).showToast()};for(let[e,n]of this.passedHexes){if(e instanceof LandUnit)for(let t of n)t.setController(e.owner,!1),HexMarker.updateMarkers(t);else e instanceof AirUnit&&(e.based?e.usedMovementPoints=0:e.usedMovementPoints=n.length-1);const a=UnitMarker.get(e);a.onclick=()=>{if(null!==t){UnitMarker.get(t).deselect();for(let e of this.passedHexes.get(t)??[])HexMarker.uncolorHex(e)}if(e===t)a.deselect(),t=null;else{a.select(),t=e;for(let e of n)HexMarker.colorHex(e,"yellow");HexMarker.colorHex(n[0],"green"),HexMarker.colorHex(n.at(-1),"red")}},a.update()}if(Countries.china.updateController(),LeftPanel.releaseNextButtonLock(n),LeftPanel.clear(),0===this.passedHexes.size?LeftPanel.appendParagraph("Your opponent hasn't moved any units. Click Next to continue."):LeftPanel.appendParagraph("Your opponent has moved their units. Click on a unit to see how it moved."),this.#e.size>0){LeftPanel.appendParagraph("The following units haven't been able to return to their bases and have been eliminated:");const e=document.createElement("div");for(let n of this.#e)e.appendChild(UnitMarker.get(n).createCopyImage());LeftPanel.appendElement(e)}if(await LeftPanel.waitForNextButtonPressed(e),null!==t)for(let e of this.passedHexes.get(t)??[])HexMarker.uncolorHex(e);for(let e of this.passedHexes.keys())UnitMarker.get(e).onclick=null}async#t(){const e=this.#n===Partnership.Allies&&Phase.current===Phase.AxisSecondMovement||this.#n===Partnership.Axis&&Phase.current===Phase.AlliedSecondMovement,n=Phase.current===Phase.AxisSecondMovement||Phase.current===Phase.AlliedSecondMovement;let t=0;const a=e?[]:[...this.#n.landUnits()],i=[...this.#n.airUnits()],s=e?[]:[...this.#n.navalUnits()].sort(((e,n)=>Number(n instanceof Convoy)-Number(e instanceof Convoy)));if(LeftPanel.appendProgressBar((()=>t/(a.length+i.length+s.length))),!e){const e=this.#a();for(let i of a)if(t++,await refreshUI(1e3),!i.hasMoved&&(!i.hasAttacked||i instanceof Armor)&&(!e.has(i.hex())||i.hex().landUnits().some((e=>e!==i))))if(i instanceof SupplyUnit){const[e,n,t]=this.#i(i,(e=>e.landUnits().some((e=>e.owner===i.owner))&&!SupplyLines.canTraceSupplyLine(e,i.owner,!1)));if(null!==e){const a=i.embarkedOn()===e,s=t.at(-1);e.setHex(s),a?e.inPort()&&i.disembark():i.embarkOnto(e),this.passedHexes.set(i,n),this.passedHexes.set(e,t),i.hasMoved=!0}}else{const e=this.#s(i)??this.#r(i),[t,a,s]=n||e?.at(-1).adjacentLandHexes().values().flatMap((e=>e.landUnits())).some((e=>e.owner.partnership()!==this.#n))?[null,null,null]:this.#i(i,(e=>[e,...e.adjacentLandHexes()].every((e=>e.controller()?.partnership()===this.#n.opponent()))));null===t||null!==e&&!e.at(-1).adjacentLandHexes().values().flatMap((e=>e.landUnits())).some((e=>e.owner.partnership()!==this.#n))?null!==e&&(i.setHex(e.at(-1)),this.passedHexes.set(i,e),i.hasMoved=!0):(t.setHex(s.at(-1)),i.embarkOnto(t),this.passedHexes.set(i,a),this.passedHexes.set(t,s),i.hasMoved=!0)}}for(let e of i)if(t++,await refreshUI(1e3),n){if(!e.based){const n=this.#o(e);if(null===n)e.die(),this.#e.add(e),UnitMarker.get(e).update();else{e.setHex(n.at(-1));const t=e.carrierBased()?e.hex().navalUnits().find((n=>e.canEmbarkOnto(n)&&0===n.embarkedUnits().size)):void 0;void 0!==t&&e.embarkOnto(t),e.based=!0,this.passedHexes.set(e,n)}}}else if(e.bomberStrength>0&&0===e.fighterStrength){const n=this.#l(e);null!==n&&(e.setHex(n.at(-1)),this.passedHexes.set(e,n))}if(!e){let e=new Map,n=new Set;e:for(let a of s)if(t++,await refreshUI(1e3),!this.passedHexes.has(a)){if(a instanceof TransportShip||a instanceof Convoy||a.remainingSupply()<=1||a.damaged()){let e=null;a instanceof Convoy&&(e=null!==a.destination?a.destination:Countries.unitedStates.partnership()!==Partnership.Neutral?Countries.unitedStates:Countries.canada);const t=this.#p(a,e);if(null!==t){const e=t.at(-1);for(;!a.canEnterHexWithinStackingLimits(e,e.navalUnits().filter((e=>!n.has(e))));){const t=e.navalUnits().find((e=>!(e instanceof Convoy||n.has(e))));if(void 0===t)continue e;n.add(t)}a.setHex(e),this.passedHexes.set(a,t);continue}}if(!(a instanceof TransportShip||a instanceof Convoy||a.damaged())){let n=e.get(a.hex())??null;if(null!==n&&a.canEnterHexWithinStackingLimits(n.at(-1))||(n=this.#h(a)),null!==n){a.setHex(n.at(-1)),e.set(a.hex(),n),this.passedHexes.set(a,n);continue}}if(n.has(a)){const e=a.hex().adjacentSeaHexes().find((e=>a.validateMovement([a.hex(),e],!1)));if(void 0!==e){const n=[a.hex(),e];a.setHex(n.at(-1)),this.passedHexes.set(a,n);continue}}}}}#r(e){const n=SupplyLines.simplifiedPathBetweenHexes(e.hex(),(n=>e.canEnterHexWithinStackingLimits(n)&&(n.adjacentLandHexes().values().flatMap((e=>e.landUnits())).some((e=>e.owner.partnership()!==this.#n))||n.controller()?.partnership()===this.#n.opponent()&&(n.isResourceHex||n.airbaseCapacity()>0)&&!n.units().some((e=>e instanceof LandUnit)))&&!n.isDesert()&&!n.isTallMountain()),e.hex().canUseRail&&e.canUseRail()?e=>e.canUseRail&&e.controller()?.partnership()===this.#n:e=>!e.isDesert()&&!e.isTallMountain());if(null===n)return null;for(let t=n.length;t>1;t--){const a=n[t-1];if(!e.canEnterHexWithinStackingLimits(a))continue;if(this.#n===Partnership.Axis&&a.country===Countries.china&&!a.adjacentLandHexes().some((e=>e.controller().partnership()===this.#n)))continue;const i=n.slice(0,t);if(e.validateMovement(i,!1))return i;if(e.canUseRail()&&e.validateMovement(i,!0))return e.movingByRail=!0,i}return null}#s(e){if(!e.outOfSupply())return null;return e.hex().adjacentLandHexes().filter((n=>SupplyLines.canTraceSupplyLine(n,e.owner))).flatMap((n=>[[e.hex(),n],...e.hex().adjacentLandHexes().map((t=>[e.hex(),t,n]))])).sort(((e,n)=>Number(n.at(-1).isInLandControlZone(this.#n.opponent()))-Number(e.at(-1).isInLandControlZone(this.#n.opponent())))).find((n=>e.validateMovement(n,!1)))??null}#i(e,n){if(!this.#n.navalUnits().some((n=>e.canEmbarkOnto(n)&&0===n.embarkedUnits().size&&n.hex().distanceFromHex(e.hex())<=e.movementAllowance)))return[null,null,null];const t=SupplyLines.simplifiedPathBetweenHexes(e.hex(),(n=>n.navalUnits().some((n=>e.canEmbarkOnto(n)&&0===n.embarkedUnits().size))),(e=>!e.isInLandControlZone(this.#n.opponent())),!1,!0,e.movementAllowance);if(null===t||!e.validateMovement(t,!1))return[null,null,null];const a=t.at(-1),i=a.navalUnits().find((n=>e.canEmbarkOnto(n)&&0===n.embarkedUnits().size));if(void 0===i)return[null,null,null];const s=SupplyLines.simplifiedPathBetweenHexes(a,(e=>n(e)&&i.canEnterHexWithinStackingLimits(e)),(e=>!e.isInNavalControlZone(this.#n.opponent(),!1)),!0,!1,i.movementAllowance);return null!==s&&i.validateMovement(s,!1)?[i,t,s]:[null,null,null]}#h(e){if(this.#u(e.hex(),e))return null;const n=SupplyLines.simplifiedPathBetweenHexes(e.hex(),(n=>e.canEnterHexWithinStackingLimits(n)&&this.#u(n,e)),(()=>!0),!0,!1,e.movementAllowance);return null!==n&&e.validateMovement(n,!1)?n:null}#u(e,n){return e.adjacentSeaHexes().values().flatMap((e=>e.navalUnits())).some((e=>e.owner.partnership()!==this.#n&&(e instanceof Submarine?n.submarineAttack>0:n.attack>0)))}#p(e,n){if(e.inPort()&&(null===n||e.hex().country===n&&!e.hex().isColony))return null;let t=SupplyLines.simplifiedPathBetweenHexes(e.hex(),(t=>(null===n||t.country===n)&&t.controller()?.partnership()===this.#n&&t.isPort()&&(null!==n||e.canEnterHexWithinStackingLimits(t))&&(null===n||!t.isColony)&&SupplyLines.canTraceSupplyLine(t,e.owner)),(n=>!n.isInNavalControlZone(this.#n.opponent(),e instanceof Submarine)),!0,!1);if(null===t||!e.validateMovement(t.slice(0,2),!1))return null;for(;!e.validateMovement(t,!1);)t.pop();return t}#l(e){const n=SupplyLines.simplifiedPathBetweenHexes(e.hex(),(e=>e.controller()?.partnership()===this.#n.opponent()&&(e.fortified()||e.airbaseCapacity()>0||e.isResourceHex&&!e.resourceHexDestroyed||e.units().some((e=>e instanceof LandUnit))&&e.adjacentLandHexes().values().flatMap((e=>e.landUnits())).some((e=>e.owner.partnership()===this.#n)))||e.navalUnits().some((e=>e.owner.partnership()!==this.#n))),(e=>!e.airUnitsGrounded()),!0,!0,e.movementAllowance/2);return null===n||n.length-1>e.movementAllowance/2||!e.validateMovement(n,!1)?null:n}#o(e){const n=SupplyLines.simplifiedPathBetweenHexes(e.hex(),(n=>n.controller()?.partnership()===this.#n&&(n.airbaseCapacity()>0||e.carrierBased()&&n.navalUnits().some((n=>e.canEmbarkOnto(n)&&0===n.embarkedUnits().size)))&&e.canEnterHexWithinStackingLimits(n)),(e=>!e.airUnitsGrounded()),!0,!0,e.movementAllowance);return null!==n&&e.validateMovement(n,!1)?n:null}#a(){let e=new Set;for(let n of this.#n.landUnits().filter((e=>e.hex().country===Countries.china&&e.hex().airbaseCapacity()>0))){const t=SupplyLines.simplifiedPathBetweenHexes(n.hex(),(e=>e.country!==Countries.china&&e.controller()?.partnership()===n.owner.partnership()||e.landUnits().some((e=>e.owner.partnership()===n.owner.partnership()&&e instanceof SupplyUnit))),(e=>e.landUnits().some((e=>e.owner.partnership()===this.#n))));t?.forEach(e.add,e)}return e}}
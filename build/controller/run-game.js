import{Partnership}from"../model/partnership.js";import{Countries}from"../model/countries.js";import{Armor,Convoy,LandUnit,Unit}from"../model/units.js";import{date,dateToString,Month}from"../model/date.js";import{Phase}from"../model/phase.js";import{SavedGames}from"../model/saved-games.js";import PhaseMarker from"../view/markers/phase-marker.js";import InfoBubble from"../view/info/info-bubble.js";import LeftPanel from"../view/left-panel.js";import PanZoom from"../view/pan-zoom.js";import Player from"./player/player.js";import UnitMarker from"../view/markers/unit-marker.js";function autosaveGame(e){const[a,t]=PanZoom.clientPixelToSvgPixel(PanZoom.instance().getPan().x,PanZoom.instance().getPan().y),r={...SavedGames.gameToJson(e),panX:a,panY:t,zoom:PanZoom.getAbsoluteZoom()},n=JSON.stringify(r);try{localStorage?.setItem("autosave",n)}catch{}const o=document.querySelector("button#saveButton");o.disabled=!1,o.onclick=()=>{const e=document.createElement("a");e.href=`data:application/json;charset=utf-8,${n}`,e.download="Saved World War 2 Game.ww2",e.click()}}function clearHasAttacked(){for(let e of Unit.allAliveUnits())e.hasAttacked&&(e.hasAttacked=!1,UnitMarker.get(e).update()),e instanceof LandUnit&&(e.hasMoved=!1),e instanceof Armor&&(e.hasDoneSuccessfulOverrun=!1)}function debarkConvoyMoney(){for(let e of Unit.allAliveUnits().filter((e=>e instanceof Convoy)))e.inPort&&null!==e.destination&&e.hex().country===e.destination&&!e.hex().isColony&&(e.destination.money+=e.money,e.destination.gotMoneyFromConvoys=!0,e.money=0,e.destination=null)}function createCountryList(e){const a=document.createElement("ul");for(let t of e){const e=document.createElement("li");e.appendChild(InfoBubble.clickableCountryInfoLink(t)),a.appendChild(e)}return a}export default async function runGame(e,a){const t=Player.fromPartnership(Partnership.Allies),r=Player.fromPartnership(Partnership.Axis);for(autosaveGame(e.partnership);!e.won()&&!a.won();){if(Phase.current===Phase.Deployment&&(PhaseMarker.update(),await a.deploymentPhase(e.deploymentPhase()),Phase.current++,Countries.china.updateController(),autosaveGame(e.partnership)),Phase.current===Phase.Income&&(PhaseMarker.update(),await Promise.all([r.incomePhase(),t.incomePhase()]),Phase.current++,autosaveGame(e.partnership)),Phase.current===Phase.UnitBuild&&(PhaseMarker.update(),await e.unitBuildPhase(),await a.unitBuildPhase(),Phase.current++,autosaveGame(e.partnership)),Phase.current===Phase.AxisOverrun&&(PhaseMarker.update(),await r.overrunPhase(),Phase.current++,Countries.china.updateController(),autosaveGame(e.partnership)),Phase.current===Phase.AxisFirstMovement){PhaseMarker.update();const a=await r.firstMovementPhase();Phase.current++,Countries.china.updateController(),PhaseMarker.update(),await t.interceptionPhase(a,null),Phase.current++,autosaveGame(e.partnership)}if(Phase.current===Phase.AxisAmphibiousParadrop&&(PhaseMarker.update(),await r.amphibiousParadropPhase(),Phase.current++,Countries.china.updateController(),autosaveGame(e.partnership)),Phase.current===Phase.AxisCombat&&(PhaseMarker.update(),await r.combatPhase(),Phase.current++,Countries.china.updateController(),autosaveGame(e.partnership)),Phase.current===Phase.AxisSecondMovement){PhaseMarker.update(),await r.secondMovementPhase(),await t.secondMovementPhase(),Phase.current++,Countries.china.updateController();for(let e of Partnership.Axis.landUnits())e.movingByRail&&(e.movingByRail=!1,UnitMarker.get(e).update());autosaveGame(e.partnership)}if(clearHasAttacked(),Phase.current===Phase.AlliedOverrun&&(PhaseMarker.update(),await t.overrunPhase(),Phase.current++,Countries.china.updateController(),autosaveGame(e.partnership)),Phase.current===Phase.AlliedFirstMovement){PhaseMarker.update();const a=await t.firstMovementPhase();Phase.current++,Countries.china.updateController(),PhaseMarker.update(),await r.interceptionPhase(a,null),Phase.current++,debarkConvoyMoney(),autosaveGame(e.partnership)}if(Phase.current===Phase.AlliedAmphibiousParadrop&&(PhaseMarker.update(),await t.amphibiousParadropPhase(),Phase.current++,Countries.china.updateController(),autosaveGame(e.partnership)),Phase.current===Phase.AlliedCombat&&(PhaseMarker.update(),await t.combatPhase(),Phase.current++,Countries.china.updateController(),autosaveGame(e.partnership)),Phase.current===Phase.AlliedSecondMovement){PhaseMarker.update(),await t.secondMovementPhase(),await r.secondMovementPhase(),Phase.current++,Countries.china.updateController();for(let e of Partnership.Allies.landUnits())e.movingByRail&&(e.movingByRail=!1,UnitMarker.get(e).update());debarkConvoyMoney(),autosaveGame(e.partnership)}if(clearHasAttacked(),Phase.current===Phase.Supply){PhaseMarker.update(),Phase.current++,date.current++,await Player.supplyPhase(),Countries.china.updateController();for(let e of Countries.all())e.hasUsedAtomicBombThisTurn=!1;autosaveGame(e.partnership)}if(Phase.current===Phase.WarDeclaration){const e=Partnership.Axis.countries(),a=Partnership.Allies.countries(),n=Countries.all().filter((e=>e.conquered()));date.current===date(1939,Month.September)&&Countries.germany.joinPartnership(Partnership.Axis);for(let e of Countries.all()){const a=[...e.units()];if(e.conquerOrLiberate(),e.addNewAvailableUnits(),e.conquered())for(let e of a)UnitMarker.get(e).update()}document.getElementById("dateLabel").textContent=dateToString(date.current);const o=Countries.spain.hasAttemptedActivation;PhaseMarker.update(),await r.warDeclarationPhase(),await t.warDeclarationPhase(),LeftPanel.clear();const s=Partnership.Axis.countries().filter((a=>!e.includes(a))),i=Partnership.Allies.countries().filter((e=>!a.includes(e))),h=Countries.all().filter((e=>e.conquered()&&!n.includes(e))),u=Countries.all().filter((e=>!e.conquered()&&n.includes(e)));0===s.length?LeftPanel.appendParagraph("No country has entered the war on the side of the Axis this turn."):(LeftPanel.appendParagraph("The following countries have entered the war on the side of the Axis this turn:"),LeftPanel.appendElement(createCountryList(s))),!o&&Countries.spain.hasAttemptedActivation&&Countries.spain.partnership()===Partnership.Neutral&&LeftPanel.appendParagraph("The Axis attempted to activate Spain and failed."),0===i.length?LeftPanel.appendParagraph("No country has entered the war on the side of the Allies this turn."):(LeftPanel.appendParagraph("The following countries have entered the war on the side of the Allies this turn:"),LeftPanel.appendElement(createCountryList(i))),0===h.length?LeftPanel.appendParagraph("No country has been conquered this turn."):(LeftPanel.appendParagraph("The following countries have been conquered this turn:"),LeftPanel.appendElement(createCountryList(h))),0===u.length?LeftPanel.appendParagraph("No country has been liberated this turn."):(LeftPanel.appendParagraph("The following countries have been liberated this turn:"),LeftPanel.appendElement(createCountryList(u))),await LeftPanel.waitForNextButtonPressed("To deployment phase")}Phase.current=Phase.Deployment,autosaveGame(e.partnership)}}
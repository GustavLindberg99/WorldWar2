import{addToMapOfSets,joinIterables}from"../../utils.js";import{Unit}from"../../model/units.js";import{date}from"../../model/date.js";import ErrorMessages from"../../view/error-messages.js";import LeftPanel from"../../view/left-panel.js";import UnitMarker from"../../view/markers/unit-marker.js";export default class HumanUnitBuildPhase{#t;#e;#n=new Set;#i=document.createElement("div");#a=document.createElement("div");constructor(t){this.#t=t,this.#e=new Set(t.availableUnits())}async run(){if(LeftPanel.clear(),LeftPanel.appendParagraph('Click on the "buy" button next to the units you want to buy.'),LeftPanel.appendBox("Units that you can buy",[this.#i]),LeftPanel.appendBox("Units that you have bought this turn",["These units will be available for use in a future turn. Exactly how long it takes before they're available [depends on the type of unit](README.md#buying-units).",this.#a]),this.#o(),this.#t.airUnits().some((t=>t.damaged()))||this.#t.navalUnits().some((t=>t.damaged()&&t.inPort))){const t=document.createElement("p");for(let e of joinIterables(this.#t.airUnits(),this.#t.navalUnits().filter((t=>t.inPort))))if(e.damaged()){const n=UnitMarker.get(e).createCopyImage(!0);n.style.verticalAlign="middle",n.style.cursor="pointer",n.onclick=()=>{e.owner.money<200?ErrorMessages.showNotEnoughMoneyError(e.owner,200):(e.owner.money-=200,e.repair(),UnitMarker.get(e).update(),t.removeChild(n),this.#t.airUnits().some((t=>t.damaged()))||this.#t.navalUnits().some((t=>t.inPort&&t.damaged()))||(t.textContent="All damaged units have been repaired."))},t.appendChild(n)}LeftPanel.appendBox("Damaged units",["The following air and naval units are damaged. Click on them to repair them (cost: $200B per air unit).",t])}await LeftPanel.waitForNextButtonPressed("To main phase");for(let t of this.#n)addToMapOfSets(t.owner.delayedUnits,date.current+t.delay(),t),t.owner.availableUnits.delete(t)}#o(){if(this.#i.replaceChildren(),0===this.#e.size)this.#i.textContent="There aren't any units available for you to buy. Click Next to continue to the next phase.";else for(let[t,e]of Unit.groupByType(this.#e)){const n=this.#r(t,e,"Buy",((t,e)=>this.#s(t,e)));this.#i.appendChild(n)}if(this.#a.replaceChildren(),0===this.#n.size)this.#a.textContent='You haven\'t bought any units yet. Click on the "buy" button next to a unit above to buy it.';else for(let[t,e]of Unit.groupByType(this.#n)){const n=this.#r(t,e,"Undo buy",(t=>this.#l(t)));this.#a.appendChild(n)}}#r(t,e,n,i){const a=document.createElement("p"),o=UnitMarker.get(t).createCopyImage(!0);a.appendChild(o);const r=document.createElement("button");if(r.onclick=()=>i(t,!0),1===e)r.textContent=n,a.appendChild(r);else{a.appendChild(document.createTextNode(`(x${e}) `)),r.textContent=`${n} one`,a.appendChild(r);const o=document.createElement("button");o.textContent=`${n} all`,o.onclick=()=>{let e=!0;const a="Buy"===n?this.#e:this.#n;for(let n of a.values().filter((e=>e.sameTypeAndStrength(t)))){if(!i(n,e))break;e=!1}},a.appendChild(o)}return a}#s(t,e){return t.owner.money<t.price()?(e&&ErrorMessages.showNotEnoughMoneyError(t.owner,t.price()),!1):(t.owner.money-=t.price(),this.#e.delete(t),this.#n.add(t),this.#o(),!0)}#l(t){return t.owner.money+=t.price(),this.#n.delete(t),this.#e.add(t),this.#o(),!0}}
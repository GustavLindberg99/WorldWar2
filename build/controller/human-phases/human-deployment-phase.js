import lodash from"https://cdn.jsdelivr.net/npm/lodash@4.17.21/+esm";import{xdialogConfirm}from"../../utils.js";import{Hex,SupplyLines}from"../../model/mapsheet.js";import{Countries}from"../../model/countries.js";import{AirUnit,LandUnit,NavalUnit,Unit}from"../../model/units.js";import{date,year}from"../../model/date.js";import HexMarker from"../../view/markers/hex-marker.js";import LeftPanel from"../../view/left-panel.js";import MoveUnitListener from"../../view/markers/move-unit-listener.js";import PlaceLandUnitsBubble from"../../view/place-land-units-bubble.js";import UnitMarker from"../../view/markers/unit-marker.js";import AirNavalAutoplacement from"../computer-player-algorithms/autoplace/air-naval-unit-autoplacement.js";import LandAutoplacement from"../computer-player-algorithms/autoplace/land-unit-autoplacement.js";export default class HumanDeploymentPhase{#t;#a=document.createElement("button");#e=document.createElement("button");#n=document.createElement("button");#i="You must place new units in their home country or in colonies of their home country on hexes that you control.";#l;#s=document.createElement("div");#o=document.createElement("p");#r=document.createElement("div");#h=document.createElement("div");#p=document.createElement("p");#d=document.createElement("div");#u=new Set;availableLandUnits;availableNavalUnits;availableAirUnits;initialUnitsAtHex=new Map;constructor(t){this.#t=t,this.availableLandUnits=this.#t.currentDelayedUnits().filter((t=>t instanceof LandUnit)),this.availableNavalUnits=this.#t.currentDelayedUnits().filter((t=>t instanceof NavalUnit)),this.availableAirUnits=this.#t.currentDelayedUnits().filter((t=>t instanceof AirUnit)),this.#a.textContent="Auto-place land units",this.#e.textContent="Auto-place naval units",this.#n.textContent="Auto-place air units",this.#c(),this.#l=new Map([[Countries.poland,this.availableNavalUnits.some((t=>t.owner===Countries.poland))?" Polish naval units may also be placed in the United Kingdom (not its colonies).":""],[Countries.japan,Countries.japan.partnership()===this.#t&&date.current===Countries.japan.enteredWar&&1939===year(Countries.japan.enteredWar)?" This turn only, Japanese units may also be placed in hexes in China within the temporary border (China will gain control of any such hex where Japanese land units are not placed this way).":""],[Countries.sovietUnion,Countries.sovietUnion.partnership()===this.#t&&date.current===Countries.sovietUnion.enteredWar?" This turn only, Soviet units may also be placed in the Baltic states, in Poland or Romania east of the temporary border, and in Finland east of the southern temporary border.":""],[Countries.unitedStates,Countries.unitedStates.partnership()===this.#t&&this.availableAirUnits.some((t=>t.owner===Countries.unitedStates))?" American air units may also be placed in any port hex controlled by the United States or the United Kingdom that is not in an enemy naval control zone.":""]]),this.#s.className="box";const a=document.createElement("h3");a.textContent="Naval and air units",this.#s.appendChild(a),this.#o.style.marginTop="0px",this.#s.appendChild(this.#o),this.#s.appendChild(this.#n),this.#s.appendChild(this.#e),this.#s.appendChild(this.#r),this.#h.className="box";const e=document.createElement("h3");e.textContent="Land units",this.#h.appendChild(e),this.#p.style.marginTop="0px",this.#h.appendChild(this.#p),this.#h.appendChild(this.#a),this.#h.appendChild(this.#d),HexMarker.onhexclick=t=>new PlaceLandUnitsBubble(t,this.#t,this),this.#a.onclick=this.#n.onclick=this.#e.onclick=t=>this.#v(t.currentTarget)}async run(){for(let t of this.#t.countries())t.delayedUnits.delete(date.current);LeftPanel.clear(),this.availableLandUnits.length>0||this.availableNavalUnits.length>0||this.availableAirUnits.length>0?(LeftPanel.appendParagraph("These are your available units."),LeftPanel.appendParagraph(this.#i+[...this.#l.values()].join("")),LeftPanel.appendParagraph("Your opponent is placing their units at the same time as you are, but neither player may see the other's units until both are done placing theirs."),LeftPanel.appendParagraph("You can also click on a hex to repair a damaged naval or air unit in it, to repair a damaged installation, or to build a new installation."),(this.availableNavalUnits.length>0||this.availableAirUnits.length>0)&&LeftPanel.appendElement(this.#s),this.availableLandUnits.length>0&&LeftPanel.appendElement(this.#h),this.updateUnitsInLeftPanel()):LeftPanel.appendParagraph("You haven't bought any units last turn. Click Next to continue, or click on a hex you control to build an installation in it or to transfer strength points between land units in it."),await LeftPanel.waitForNextButtonPressed("To income phase",(()=>!(this.availableLandUnits.length>0||this.availableNavalUnits.length>0||this.availableAirUnits.length>0)||xdialogConfirm("Lose remaining units?",this.availableLandUnits.length>0?"You haven't placed all your land units on the map. To place them on the map, click on where you want to place it and then either click on \"Create new unit\" or increase the strength of an existing unit.<br/><br/>Units that you don't place on the map will be lost. Do you want to continue?":"You haven't placed all your naval or air units on the map. To place them on the map, drag the unit to where you want to place it.<br/><br/>Units that you don't place on the map will be lost. Do you want to continue?")));for(let t of[...this.availableLandUnits,...this.availableNavalUnits,...this.availableAirUnits])t.owner.availableUnits.add(t);for(let t of this.#u)t.delete();HexMarker.onhexclick=null}updateUnitsInLeftPanel(){const t="To place a land unit on the map, click on the hex on which you want to place it and choose how many strength points of each type you want to put there.";this.#c(),this.availableNavalUnits.length>0||this.availableAirUnits.length>0?(this.#o.textContent="Drag a naval or air unit to the hex on which you want to place it.",this.#o.style.marginBottom="8px"):(this.#o.textContent="No more naval or air units available",this.#o.style.marginBottom="0px"),this.availableLandUnits.length>0?(this.#p.textContent=t,this.#p.style.marginBottom="8px"):(this.#p.textContent="No more land units available",this.#p.style.marginBottom="0px"),this.#r.replaceChildren();for(let t of[...this.availableAirUnits,...this.availableNavalUnits]){const a=UnitMarker.get(t).createCopyImage(!0);this.#r.appendChild(a);new MoveUnitListener(t,a,!1).ondragfinished=a=>this.#m(t,a)}this.#d.replaceChildren();for(let[a,e]of Unit.groupByType(this.availableLandUnits)){const n=document.createElement("span");n.style.whiteSpace="nowrap",n.style.margin="4px",n.style.display="inline-block";const i=UnitMarker.get(a).createCopyImage(!0);i.style.verticalAlign="middle",i.onclick=()=>Toastify({text:t}).showToast(),n.appendChild(i),e>1&&n.appendChild(document.createTextNode("(x"+e+") ")),this.#d.appendChild(n)}}#c(){this.#a.disabled=0===this.availableLandUnits.length,this.#e.disabled=0===this.availableNavalUnits.length,this.#n.disabled=0===this.availableAirUnits.length}#m(t,a){if(a===t.hex())return;if(null===a)return t instanceof AirUnit&&!this.availableAirUnits.includes(t)&&this.availableAirUnits.push(t),t instanceof NavalUnit&&!this.availableNavalUnits.includes(t)&&this.availableNavalUnits.push(t),t.delete(),UnitMarker.get(t).update(),void this.updateUnitsInLeftPanel();if(!a.unitCanBePlacedHere(t))return void Toastify({text:this.#i+(this.#l.get(t.owner)??"")}).showToast();if(!t.canEnterHexWithinStackingLimits(a,!0))return void(t instanceof AirUnit&&0===a.airbaseCapacity()?Toastify({text:"Air units must be placed on airbases (this includes cities, resource hexes, and airbase installations)."}).showToast():t instanceof NavalUnit&&!a.isPort()?Toastify({text:"Naval units must be placed in ports (this includes any city in a coastal hex)."}).showToast():Toastify({text:"There isn't room for this unit in this hex."}).showToast());if(!SupplyLines.canTraceSupplyLine(a,t.owner))return void Toastify({text:"New units can't be placed in hexes that are out of supply."}).showToast();t.setHex(a),t instanceof AirUnit?(lodash.pull(this.availableAirUnits,t),t.based=!0):(lodash.pull(this.availableNavalUnits,t),t.inPort=!0),UnitMarker.get(t).update(),this.updateUnitsInLeftPanel();const e=UnitMarker.get(t).createMoveUnitListener(!1);e.ondragfinished=a=>this.#m(t,a),this.#u.add(e)}async#v(t){const a=t.textContent;t.textContent="Auto-placing units...",t.disabled=!0;let e="";switch(t){case this.#a:e="Auto-placing land units...",LeftPanel.addNextButtonLock(e);const t=this.availableLandUnits;this.availableLandUnits=[],this.updateUnitsInLeftPanel();const a=await LandAutoplacement.getLandUnitAutoplacement(this.#t,t);for(let t of a.values().filter((t=>t instanceof Hex)))this.initialUnitsAtHex.has(t)||this.initialUnitsAtHex.set(t,[...t.landUnits().map((t=>t.clone()))]);LandAutoplacement.placeLandUnits(a),this.availableLandUnits=t.filter((t=>!a.has(t)));break;case this.#n:e="Auto-placing air units...",LeftPanel.addNextButtonLock(e);const n=this.availableAirUnits;this.availableAirUnits=[],this.updateUnitsInLeftPanel();const i=await AirNavalAutoplacement.getAirUnitAutoplacement(this.#t,n);AirNavalAutoplacement.placeAirNavalUnits(i),this.availableAirUnits=n.filter((t=>!i.has(t)));for(let t of i.keys()){const a=UnitMarker.get(t).createMoveUnitListener(!1);a.ondragfinished=a=>this.#m(t,a),this.#u.add(a)}break;case this.#e:e="Auto-placing naval units...",LeftPanel.addNextButtonLock(e);const l=this.availableNavalUnits;this.availableNavalUnits=[],this.updateUnitsInLeftPanel();const s=await AirNavalAutoplacement.getNavalUnitAutoplacement(this.#t,l);AirNavalAutoplacement.placeAirNavalUnits(s),this.availableNavalUnits=l.filter((t=>!s.has(t)));for(let t of s.keys()){const a=UnitMarker.get(t).createMoveUnitListener(!1);a.ondragfinished=a=>this.#m(t,a),this.#u.add(a)}}t.textContent=a,t.disabled=!1,this.updateUnitsInLeftPanel(),LeftPanel.releaseNextButtonLock(e)}}
import{Countries}from"../../model/countries.js";import{Convoy}from"../../model/units.js";import InfoBubble from"../../view/info/info-bubble.js";import LeftPanel from"../../view/left-panel.js";import UnitMarker from"../../view/markers/unit-marker.js";export default class HumanMoneyExchange{#e;#t=[];constructor(e){this.#e=e}async run(){LeftPanel.clear(),LeftPanel.appendParagraph("All countries at war have received their monthly income.");const e=new Map([Countries.japan,Countries.germany,Countries.unitedStates,Countries.unitedKingdom,Countries.china].filter((e=>e.partnership()===this.#e)).map((e=>[e,this.#e.countries().filter((t=>t.canSendMoneyWithoutConvoys().includes(e)&&(e.canSendMoneyWithoutConvoys().includes(t)||e===Countries.japan||e===Countries.china)))]))),t=new Map(Countries.all().filter((e=>e.partnership()===this.#e)).map((e=>[e,Countries.all().filter((t=>e.canSendMoneyWithConvoys().includes(t)))])));if(e.size>0){const t=document.createElement("table");t.className="moneyExchange";let n=[];for(let[o,a]of e)if(a.length>2){const e=document.createElement("p");e.appendChild(document.createTextNode(`${o.name()} can exchange money with the following countries: `));const i=this.#n(a);e.appendChild(i);const l=document.createElement("button");l.textContent="Add",l.onclick=()=>{const n=i.selectedOptions[0],a=Countries.fromName(n?.textContent);null!==a?(t.appendChild(this.#o(o,[a],null)),n.remove(),i.hasChildNodes()||e.remove()):Toastify({text:"You must select a country to exchange money with."}).showToast()},e.appendChild(l),n.push(e)}else for(let e of a)t.appendChild(this.#o(o,[e],null));LeftPanel.appendBox("Money exchanges without convoys",["The receiving country will receive this money directly at the end of this income phase.",t,...n])}if(t.size>0){const e=document.createElement("table");e.className="moneyExchange";for(let n of this.#e.convoys()){const o=n.hex().country,a=t.get(o);null!==o&&o.partnership()===this.#e&&void 0!==a&&0!==a.length&&e.appendChild(this.#o(o,a,n))}e.hasChildNodes()&&LeftPanel.appendBox("Money exchanges with convoys",["The sending country will pay this money directly, and the money will be placed on a convoy unit. The convoy unit will then have to move to a friendly port in the receiving country, after which the receiving country will be able to use it.",e])}await LeftPanel.waitForNextButtonPressed("To unit build phase");for(let e of this.#t){const t=e.leftButton.classList.contains("selected"),n=Countries.fromName(e.receiverDropdown.selectedOptions[0]?.value),o=parseInt(e.amountInput.value);if(null===n||isNaN(o))continue;const a=t?n:e.sender,i=t?e.sender:n;a.money-=o,null!==e.convoy?(e.convoy.money=o,e.convoy.destination=i):i.money+=o}}#a(e){const t=document.createElement("td");return t.appendChild(InfoBubble.clickableCountryInfoLink(e)),t.appendChild(document.createElement("br")),t.appendChild(document.createTextNode(`$${e.money.toLocaleString()}B`)),t}#n(e){const t=document.createElement("select");for(let n of e){const e=document.createElement("option");e.textContent=n.name(),t.appendChild(e)}return t}#i(e){parseInt(e.value)>parseInt(e.max)?e.value=e.max:parseInt(e.value)<parseInt(e.min)&&(e.value=e.min),e.value=(parseInt(e.value)||0).toString()}#l(e,t,n,o,a){o.classList.add("selected"),n.classList.remove("selected"),t.max=Math.min(e.maxMoneyExchange(),a?Convoy.maxMoney:1/0).toString(),t.step=Math.min(50,e.money).toString(),this.#i(t)}#o(e,t,n){const o=document.createElement("tr"),a=document.createElement("button"),i=document.createElement("input"),l=document.createElement("button"),r=this.#n(t);a.className="moneyExchange",a.textContent="←",a.onclick=()=>this.#l(t[r.selectedIndex],i,l,a,null!==n),i.type="number",i.min="0",i.onchange=()=>this.#i(i),l.className="moneyExchange",l.textContent="→",l.onclick=()=>this.#l(e,i,a,l,null!==n),r.onchange=()=>{a.classList.contains("selected")&&this.#l(t[r.selectedIndex],i,l,a,null!==n)},o.appendChild(this.#a(e));const s=document.createElement("td");null!==n?s.appendChild(UnitMarker.get(n).createCopyImage(!0)):s.appendChild(a),o.appendChild(s);const c=document.createElement("td");c.appendChild(i),o.appendChild(c);const d=document.createElement("td");if(d.appendChild(l),o.appendChild(d),1===t.length)o.appendChild(this.#a(t[0]));else{const e=document.createElement("td");e.appendChild(r),o.appendChild(e)}return null!==n||t.some((t=>e.canSendMoneyWithoutConvoys().includes(t)))?this.#l(e,i,a,l,null!==n):(l.disabled=!0,this.#l(t[r.selectedIndex],i,l,a,null!==n)),this.#t.push({amountInput:i,leftButton:a,sender:e,receiverDropdown:r,convoy:n}),o}}